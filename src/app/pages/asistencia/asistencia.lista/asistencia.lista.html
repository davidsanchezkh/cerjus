<div class="d-flex align-items-center justify-content-center gap-2 mb-3">
  <button type="button" class="btn btn-success"
          (click)="marcarEntrada()" 
          [disabled]="loading || marcando">
    Marcar entrada
  </button>
   <button type="button" class="btn btn-warning"
          (click)="marcarSalida()"
          [disabled]="loading || marcando">
    Marcar salida 
  </button>
</div>

<div [formGroup]="form" class="card card--flat">
  <div class="card-body p-0 tabla-wrap"
       [class.is-loading]="loading"
       [class.skeleton-mode]="firstLoad || (loading && items.length === 0)"
       [style.minHeight.px]="listMinHeight"
       [style.--thead-h.px]="headerBlockPx"
       style="position: relative;">

    <table class="table table-striped table-hover m-0">
      <thead class="table-light">
        <tr>
          <th style="width: 15rem;">Fecha</th>
          <th style="width: 4rem;">#</th>
          <th >Tipo</th>
          
        </tr>

        <!-- Filtros -->
      </thead>

      <tbody>
        <!-- SKELETON filas (primera carga o carga sin datos previos) -->
        @if (firstLoad || (loading && items.length === 0)) {
          @for (_ of skeletonRows; track $index) {
            <tr class="tbody-skeleton">
              <td style="width: 10rem;">
                <div class="sk-wrap"><div class="sk-cell sk-text"></div></div>
              </td>
              <td style="width: 4rem;">
                <div class="sk-wrap"><div class="sk-cell sk-id"></div></div>
              </td>
              <td >
                <div class="sk-wrap"><div class="sk-cell sk-text"></div></div>
              </td>
              
            </tr>
          }
        } @else {
          <!-- FILAS REALES -->
          @if (items.length > 0) {
             @for (c of items; track (c.idmarcaasistencia + '-' + c.idmarca)) {
              <tr>
                <td style="width: 15rem;">{{ c.fecha_formato }}</td>
                <td style="width: 4rem;">{{ c.idmarca }}</td>
                <td>
                  <span
                    class="tipo-text"
                    [ngClass]="{
                      'entrada': (c.tipo || '').toLowerCase() === 'entrada',
                      'salida': (c.tipo || '').toLowerCase() === 'salida'
                    }"
                  >
                    {{ c.tipo }}
                  </span>
                </td>
                
              </tr>
            }
          }
        }
      </tbody>
    </table>

    <!-- OVERLAY: estado vacío (con debounce, estable) -->
    @if (showEmpty) {
      <div class="empty-overlay">
        <div class="text-center text-muted estado-vacio fullheight">
          No se encontraron resultados.
        </div>
      </div>
    }

    <!-- OVERLAY de carga solo si ya había datos (evita destellos) -->
    @if (showOverlay && items.length > 0) {
      <div class="loading-overlay d-flex align-items-center justify-content-center">
        Cargando…
      </div>
    }
  </div>
</div>

<!-- Paginación con contadores desacoplados (shown*) y reserva de ancho -->
<div class="d-flex align-items-center justify-content-between mt-3 pager-wrap"
     [class.is-loading]="loading"
     [style.--range-min.ch]="rangeReserveCh"
     [style.--total-min.ch]="totalReserveCh"
     style="user-select: none;">
  <div class="text-muted small">
    Página
    <span class="num-range">{{ shownPage }}</span>
    de
    <span class="num-range">{{ shownLastPage }}</span>
    —
    Mostrando
    <span class="num-range">
      @if (shownFrom > 0) { {{ shownFrom }}&ndash;{{ shownTo }} } @else { 0 }
    </span>
    de
    <span class="total-num">{{ shownTotal }}</span>
  </div>

  <ul class="pagination m-0" style="user-select: none;">
    <li class="page-item" [class.disabled]="page === 1 || loading">
      <button class="page-link" (click)="goTo(page - 1)" [disabled]="page === 1 || loading">Anterior</button>
    </li>
    <li class="page-item" [class.disabled]="page >= lastPage || loading">
      <button class="page-link" (click)="goTo(page + 1)" [disabled]="page >= lastPage || loading">Siguiente</button>
    </li>
  </ul>
</div>