<div class="analytics-shell">
  <!-- ===== Encabezado principal ===== -->
  <div class="card analytics-header mb-3 shadow-sm">
    <div class="card-body analytics-header-body">
      <div class="analytics-header-main">
        <div class="analytics-title">Panel de analíticas</div>

        <!-- Subtítulo con rango + filtros + ETL, ahora con letra más grande -->
        <div class="analytics-subtitle text-light">
          {{ headerDetail || 'Configure los filtros para ver el detalle.' }}
        </div>
      </div>

      <!-- Meta: periodo, estado ETL y botón de exportación de TODO el panel -->
      <div
        class="ms-auto d-flex flex-column flex-sm-row gap-2 align-items-sm-center analytics-header-meta"
      >
        <span class="badge period-badge">
          {{ periodMain || 'Periodo actual' }}
        </span>

        <span class="analytics-etl-label">
          {{ etlLabel }}
        </span>

        <!-- Botón que exporta el panel completo como PNG -->
        <button
          type="button"
          class="btn btn-sm btn-outline-light analytics-export-btn"
          (click)="exportPanelPng()"
        >
          Exportar panel (PNG)
        </button>
      </div>
    </div>
  </div>

  <!-- ====== Toolbar de filtros ====== -->
  <div class="card mb-3 shadow-sm">
    <div
      class="card-body d-flex flex-wrap align-items-center gap-3 analytics-toolbar"
    >
      <!-- botones de periodo -->
      <div class="d-flex flex-wrap gap-2">
        <div class="btn-group btn-group-sm" role="group" aria-label="Periodo">
          <button
            type="button"
            class="btn btn-filter"
            [class.active]="filtros.value.kind==='week'"
            (click)="filtros.patchValue({ kind: 'week',  view: 'day' }, { emitEvent: true })"
          >
            Semana
          </button>
          <button
            type="button"
            class="btn btn-filter"
            [class.active]="filtros.value.kind==='month'"
            (click)="filtros.patchValue({ kind: 'month', view: 'day' }, { emitEvent: true })"
          >
            Mes
          </button>
          <button
            type="button"
            class="btn btn-filter"
            [class.active]="filtros.value.kind==='year'"
            (click)="filtros.patchValue({ kind: 'year',  view: 'month' }, { emitEvent: true })"
          >
            Año
          </button>
        </div>

        <div class="btn-group btn-group-sm" role="group" aria-label="Rango">
          <button
            type="button"
            class="btn btn-filter"
            [class.active]="filtros.value.range==='this'"
            (click)="filtros.patchValue({ range: 'this' }, { emitEvent: true })"
          >
            Este
          </button>
          <button
            type="button"
            class="btn btn-filter"
            [class.active]="filtros.value.range==='last'"
            (click)="filtros.patchValue({ range: 'last' }, { emitEvent: true })"
          >
            Pasado
          </button>
        </div>
      </div>

      <!-- selects de materia / canal / usuario -->
      <div class="filters-selects d-flex flex-wrap gap-2 flex-fill">
        <select
          class="form-select form-select-sm filter-select"
          [formControl]="filtros.controls.materia_id"
        >
          <option [ngValue]="null">Todas las materias</option>
          <option *ngFor="let m of materias" [ngValue]="m.materia_id">
            {{ m.materia_nombre }}
          </option>
        </select>

        <select
          class="form-select form-select-sm filter-select"
          [formControl]="filtros.controls.canal_id"
        >
          <option [ngValue]="null">Todos los canales</option>
          <option *ngFor="let c of canales" [ngValue]="c.canal_id">
            {{ c.canal_nombre }}
          </option>
        </select>

        <select
          class="form-select form-select-sm filter-select"
          [formControl]="filtros.controls.us_id"
        >
          <option [ngValue]="null">Todos los usuarios</option>
          <option *ngFor="let u of usuarios" [ngValue]="u.us_id">
            {{ u.nombres }} {{ u.apellidos }}
          </option>
        </select>
      </div>

      <div class="ms-sm-auto">
        <button class="btn btn-sm btn-outline-primary px-3" (click)="actualizar()">
          Actualizar
        </button>
      </div>
    </div>
  </div>

  <!-- ====== Acciones ETL rápidas ====== -->
  <div class="card mb-3 shadow-sm">
    <div class="card-body d-flex flex-wrap align-items-center gap-2">
      <div class="etl-label">ETL</div>

      <!-- Supervisión -->
      <div class="btn-group btn-group-sm flex-wrap" role="group">
        <button class="btn btn-ghost" (click)="runPreset('TODAY')">Hoy</button>
        <button class="btn btn-ghost" (click)="runPreset('WEEK_THIS')">
          Esta semana
        </button>
        <button class="btn btn-ghost" (click)="runPreset('WEEK_LAST')">
          Semana pasada
        </button>
        <button class="btn btn-ghost" (click)="runPreset('MONTH_THIS')">
          Este mes
        </button>
        <button class="btn btn-ghost" (click)="runPreset('MONTH_LAST')">
          Mes pasado
        </button>
        <button class="btn btn-ghost btn-warning-soft" (click)="runFillMissing()">
          Completar faltantes → hoy
        </button>
      </div>

      <span class="vr mx-2 d-none d-lg-inline"></span>

      <!-- Admin -->
      <div class="btn-group btn-group-sm flex-wrap" role="group">
        <button class="btn btn-ghost btn-danger-soft" (click)="runPreset('YEAR_THIS')">
          Año actual
        </button>
        <button class="btn btn-ghost btn-danger-soft" (click)="runPreset('YEAR_LAST')">
          Año anterior
        </button>
      </div>

      <div class="ms-auto small">
        <span class="text-muted">Estado:</span>
        <span
          [class.text-warning]="etlStatus?.running"
          [class.text-success]="!etlStatus?.running"
        >
          {{ etlStatus?.running ? 'EN PROCESO' : 'SIN EJECUCIONES ACTIVAS' }}
        </span>
      </div>
    </div>
  </div>

  <!-- ====== Gráficos ====== -->
  <div class="row g-3 analytics-layout">
    <!-- Columna izquierda: línea + barras -->
    <div class="col-lg-8 col-xl-9 d-flex flex-column gap-3">
      <!-- Línea: Ciudadanos registrados -->
      <div class="card analytics-card shadow-sm">
        <div
          class="card-header border-0 bg-transparent d-flex justify-content-between align-items-center pb-0"
        >
          <h6 class="mb-0 analytics-card-title">Ciudadanos registrados</h6>
          <!-- Ya NO hay botón "Descargar PNG" propio.
               Se usará el botón de la toolbar nativa de ApexCharts. -->
        </div>
        <div class="card-body">
          <apx-chart
            #chartLine
            [series]="optLine.series"
            [chart]="optLine.chart"
            [xaxis]="optLine.xaxis"
            [dataLabels]="optLine.dataLabels"
            [stroke]="optLine.stroke"
            [legend]="optLine.legend"
            [tooltip]="optLine.tooltip"
            [title]="optLine.title"
            [subtitle]="optLine.subtitle"
          >
          </apx-chart>
        </div>
      </div>

      <!-- Barras apiladas: Atenciones -->
      <div class="card analytics-card shadow-sm">
        <div
          class="card-header border-0 bg-transparent d-flex justify-content-between align-items-center pb-0"
        >
          <h6 class="mb-0 analytics-card-title">
            Atenciones (Consultas + Seguimientos)
          </h6>
          <!-- Sin botón extra, se usa toolbar de Apex -->
        </div>
        <div class="card-body">
          <apx-chart
            #chartBar
            [series]="optBar.series"
            [chart]="optBar.chart"
            [xaxis]="optBar.xaxis"
            [plotOptions]="optBar.plotOptions"
            [dataLabels]="optBar.dataLabels"
            [legend]="optBar.legend"
            [tooltip]="optBar.tooltip"
            [title]="optBar.title"
            [subtitle]="optBar.subtitle"
          >
          </apx-chart>
        </div>
      </div>
    </div>

    <!-- Columna derecha: Donut -->
    <div class="col-lg-4 col-xl-3">
      <div class="card analytics-card shadow-sm h-100">
        <div
          class="card-header border-0 bg-transparent d-flex justify-content-between align-items-center pb-0"
        >
          <h6 class="mb-0 analytics-card-title">Materias de la consulta</h6>
          <!-- Sin botón extra, se usa toolbar de Apex -->
        </div>
        <div class="card-body">
          <apx-chart
            #chartDonut
            [series]="optDonut.series"
            [chart]="optDonut.chart"
            [labels]="optDonut.labels"
            [legend]="optDonut.legend"
            [tooltip]="optDonut.tooltip"
            [title]="optDonut.title"
            [subtitle]="optDonut.subtitle"
          >
          </apx-chart>
        </div>
      </div>
    </div>
  </div>
</div>
