
<div [formGroup]="form" class="card card--flat">
  <div class="card-body p-0 tabla-wrap"
       [class.is-loading]="loading"
       [class.skeleton-mode]="firstLoad || (loading && items.length === 0)"
       [style.minHeight.px]="listMinHeight"
       [style.--thead-h.px]="headerBlockPx"
       style="position: relative;">

    <table class="table table-striped table-hover m-0">
      <thead class="table-light">
        <tr>
          <th style="width: 8.5rem;">Fecha</th>
          <th style="width: 7rem;">User</th>
          <th style="width: 13rem;">Tipo</th>
          <th style="width: 10rem;">Estado</th>
          <th>Motivo</th>
          <th style="width: 16rem;">Acciones</th>
        </tr>

        <tr class="filters-row" style="user-select:none;">
        <!-- Fecha: desde + hasta en la MISMA columna -->
        <th>
            <div class="d-flex flex-column gap-1">
            <input class="form-control form-control-sm" type="date" formControlName="desde">
            <input class="form-control form-control-sm" type="date" formControlName="hasta">
            </div>
        </th>

        <!-- User -->
        <th>
            <input class="form-control form-control-sm no-spinner"
                type="number" min="0" step="1"
                formControlName="us_id" placeholder="ID"
                (wheel)="$event.preventDefault()">
        </th>

        <!-- Tipo -->
        <th>
            <select class="form-select form-select-sm" formControlName="tipo">
            @for (opt of tipoOpciones; track opt.value) {
                <option [value]="opt.value">{{ opt.label }}</option>
            }
            </select>
        </th>

        <!-- Estado -->
        <th>
            <select class="form-select form-select-sm" formControlName="estado">
            @for (opt of estadoOpciones; track opt.value) {
                <option [value]="opt.value">{{ opt.label }}</option>
            }
            </select>
        </th>

        <!-- Motivo (sin filtro) -->
        <th></th>

        <!-- Acción -->
        <th>
            <button type="button" class="btn btn-sm btn-outline-secondary" (click)="clear()">Limpiar</button>
        </th>
        </tr>
      </thead>

      <tbody>
        @if (firstLoad) {
          @for (_ of skeletonRows; track $index) {
            <tr class="tbody-skeleton">
              <td><div class="sk-wrap"><div class="sk-cell sk-date"></div></div></td>
              <td><div class="sk-wrap"><div class="sk-cell sk-id"></div></div></td>
              <td><div class="sk-wrap"><div class="sk-cell sk-text"></div></div></td>
              <td><div class="sk-wrap"><div class="sk-cell sk-badge"></div></div></td>
              <td><div class="sk-wrap"><div class="sk-cell sk-text"></div></div></td>
              <td><div class="sk-wrap"><div class="sk-cell sk-btn"></div></div></td>
            </tr>
          }
        } @else {
          @if (items.length > 0) {
            @for (j of items; track j.aj_ID) {
              <tr>
                <td style="width:8.5rem;">{{ j.fecha_label ?? j.fecha_ymd }}</td>
                <td style="width:7rem;">{{ j.us_id }}</td>
                <td style="width:13rem;">{{ j.tipo_label ?? j.tipo }}</td>
                <td style="width:10rem;">
                  <span class="badge" [ngClass]="estadoBadgeClass(j.estado)">{{ j.estado_label ?? j.estado }}</span>
                </td>
                <td title="{{ j.motivo }}">{{ j.motivo }}</td>
                <td style="width:16rem;">
                  <button class="btn btn-sm btn-success me-2"
                          type="button"
                          [disabled]="j.estado !== 'PENDIENTE' || loading"
                          (click)="abrirDecision('APROBAR', j)">
                    Aprobar
                  </button>
                  <button class="btn btn-sm btn-danger"
                          type="button"
                          [disabled]="j.estado !== 'PENDIENTE' || loading"
                          (click)="abrirDecision('RECHAZAR', j)">
                    Rechazar
                  </button>
                </td>
              </tr>
            }
          }
        }
      </tbody>
    </table>

    @if (showEmpty && !loading) {
      <div class="empty-overlay">
        <div class="text-center text-muted estado-vacio fullheight">
          No se encontraron resultados.
        </div>
      </div>
    }

    @if (showOverlay && items.length > 0) {
      <div class="loading-overlay d-flex align-items-center justify-content-center">
        Cargando…
      </div>
    }
  </div>
</div>

<div class="d-flex align-items-center justify-content-between mt-3 pager-wrap"
     [class.is-loading]="loading"
     [style.--range-min.ch]="rangeReserveCh"
     [style.--total-min.ch]="totalReserveCh"
     style="user-select:none;">
  <div class="text-muted small">
    Página <span class="num-range">{{ shownPage }}</span>
    de <span class="num-range">{{ shownLastPage }}</span>
    — Mostrando
    <span class="num-range">
      @if (shownFrom > 0) { {{ shownFrom }}&ndash;{{ shownTo }} } @else { 0 }
    </span>
    de <span class="total-num">{{ shownTotal }}</span>
  </div>

  <ul class="pagination m-0">
    <li class="page-item" [class.disabled]="page === 1 || loading">
      <button class="page-link" (click)="goTo(page - 1)" [disabled]="page === 1 || loading">Anterior</button>
    </li>
    <li class="page-item" [class.disabled]="page >= lastPage || loading">
      <button class="page-link" (click)="goTo(page + 1)" [disabled]="page >= lastPage || loading">Siguiente</button>
    </li>
  </ul>
</div>

<!-- ===== Modal simple (sin dependencias externas) ===== -->
@if (decisionOpen) {
  <div class="modal-backdrop-custom"></div>
  <div class="modal-custom">
    <div class="modal-card">
      <div class="modal-header">
        <div class="fw-semibold">
          @if (decisionMode === 'APROBAR') { Aprobar } @else { Rechazar }
          solicitud #{{ decisionItem?.aj_ID }}
        </div>
        <button class="btn-close" type="button" (click)="cerrarDecision()"></button>
      </div>

      <div class="modal-body" [formGroup]="decisionForm">
        <div class="mb-2 text-muted small">
          Fecha: {{ decisionItem?.fecha_ymd }} — Usuario: {{ decisionItem?.us_id }}
        </div>

        <label class="form-label fw-semibold">Motivo de decisión</label>
        <textarea class="form-control" rows="3" maxlength="255" formControlName="motivo"></textarea>
        <div class="text-muted small mt-1">Máx. 255 caracteres.</div>
      </div>

      <div class="modal-footer">
        <button class="btn btn-outline-secondary" type="button" (click)="cerrarDecision()">Cancelar</button>
        <button class="btn" [class.btn-success]="decisionMode==='APROBAR'" [class.btn-danger]="decisionMode==='RECHAZAR'"
                type="button" (click)="confirmarDecision()">
          Confirmar
        </button>
      </div>
    </div>
  </div>
}
