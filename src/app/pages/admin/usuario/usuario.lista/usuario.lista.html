<!-- src/app/pages/usuario/usuario.lista/usuario.lista.html -->

<div [formGroup]="form" class="card card--flat">
  <div
    class="card-body p-0 tabla-wrap"
    [class.is-loading]="loading"
    [class.skeleton-mode]="firstLoad || (loading && items.length === 0)"
    [style.minHeight.px]="listMinHeight"
    [style.--thead-h.px]="headerBlockPx"
    style="position: relative;"
  >
    <table class="table table-striped table-hover m-0">
      <thead class="table-light">
        <tr>
          <th style="width: 8rem;">ID</th>
          <th style="width: 10rem;">DNI</th>
          <th>Apellido paterno</th>
          <th>Apellido materno</th>
          <th>Nombres</th>
          <th style="width: 9rem;">Creado el</th>
          <th style="width: 10rem;">Opciones</th>
        </tr>

        <!-- Filtros -->
        <tr class="filters-row" style="user-select: none;">
          <th>
            <input
              class="form-control form-control-sm no-spinner"
              formControlName="id"
              placeholder="ID"
              type="number"
              min="0"
              step="1"
              (wheel)="$event.preventDefault()"
            />
          </th>
          <th>
            <input
              class="form-control form-control-sm"
              formControlName="dni"
              placeholder="DNI"
            />
          </th>
          <th>
            <input
              class="form-control form-control-sm"
              formControlName="apellidoPaterno"
              placeholder="Apellido paterno"
            />
          </th>
          <th>
            <input
              class="form-control form-control-sm"
              formControlName="apellidoMaterno"
              placeholder="Apellido materno"
            />
          </th>
          <th>
            <input
              class="form-control form-control-sm"
              formControlName="nombres"
              placeholder="Nombres"
            />
          </th>
          <th></th>
          <th>
            <button
              type="button"
              class="btn btn-sm btn-outline-secondary"
              (click)="clear()"
            >
              Limpiar
            </button>
          </th>
        </tr>
      </thead>

      <tbody>
        <!-- SKELETON filas SOLO en primera carga -->
        @if (firstLoad) {
          @for (_ of skeletonRows; track $index) {
            <tr class="tbody-skeleton">
              <td style="width: 8rem;">
                <div class="sk-wrap"><div class="sk-cell sk-id"></div></div>
              </td>
              <td style="width: 10rem;">
                <div class="sk-wrap"><div class="sk-cell sk-text"></div></div>
              </td>
              <td>
                <div class="sk-wrap"><div class="sk-cell sk-text"></div></div>
              </td>
              <td>
                <div class="sk-wrap"><div class="sk-cell sk-text"></div></div>
              </td>
              <td>
                <div class="sk-wrap"><div class="sk-cell sk-text"></div></div>
              </td>
              <td style="width: 9rem;">
                <div class="sk-wrap"><div class="sk-cell sk-date"></div></div>
              </td>
              <td style="width: 10rem;">
                <div class="sk-wrap"><div class="sk-cell sk-btn"></div></div>
              </td>
            </tr>
          }
        } @else {
          <!-- FILAS REALES -->
          @if (items.length > 0) {
            @for (c of items; track c.id) {
              <tr>
                <td style="width: 8rem;">{{ c.id }}</td>
                <td style="width: 10rem;">{{ c.dni }}</td>
                <td>{{ c.apellidoPaterno }}</td>
                <td>{{ c.apellidoMaterno }}</td>
                <td>{{ c.nombres }}</td>
                <td style="width: 9rem;">
                  {{ c.fechaCreadoPor | date: 'dd/MM/yyyy' }}
                </td>
                <td style="width: 10rem;">
                  <a
                    class="btn btn-sm btn-outline-primary"
                    [routerLink]="['/admin/usuario', c.id]"
                  >
                    Ver
                  </a>
                </td>
              </tr>
            }
          }
        }
      </tbody>
    </table>

    <!-- OVERLAY: estado vacío (con debounce, estable) -->
    @if (showEmpty && !loading) {
      <div class="empty-overlay">
        <div class="text-center text-muted estado-vacio fullheight">
          No se encontraron resultados.
        </div>
      </div>
    }

    <!-- OVERLAY de carga solo si ya había datos (evita destellos) -->
    @if (showOverlay && items.length > 0) {
      <div class="loading-overlay d-flex align-items-center justify-content-center">
        Cargando…
      </div>
    }
  </div>
</div>

<!-- Paginación con contadores desacoplados (shown*) y reserva de ancho -->
<div
  class="d-flex align-items-center justify-content-between mt-3 pager-wrap"
  [class.is-loading]="loading"
  [style.--range-min.ch]="rangeReserveCh"
  [style.--total-min.ch]="totalReserveCh"
  style="user-select: none;"
>
  <div class="text-muted small">
    Página
    <span class="num-range">{{ shownPage }}</span>
    de
    <span class="num-range">{{ shownLastPage }}</span>
    —
    Mostrando
    <span class="num-range">
      @if (shownFrom > 0) { {{ shownFrom }}&ndash;{{ shownTo }} } @else { 0 }
    </span>
    de
    <span class="total-num">{{ shownTotal }}</span>
  </div>

  <ul class="pagination m-0" style="user-select: none;">
    <li class="page-item" [class.disabled]="page === 1 || loading">
      <button
        class="page-link"
        (click)="goTo(page - 1)"
        [disabled]="page === 1 || loading"
      >
        Anterior
      </button>
    </li>
    <li class="page-item" [class.disabled]="page >= lastPage || loading">
      <button
        class="page-link"
        (click)="goTo(page + 1)"
        [disabled]="page >= lastPage || loading"
      >
        Siguiente
      </button>
    </li>
  </ul>
</div>
