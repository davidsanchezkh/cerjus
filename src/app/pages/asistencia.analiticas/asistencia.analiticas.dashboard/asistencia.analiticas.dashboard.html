<div class="asist-shell">
  <!-- ===== Encabezado ===== -->
  <div class="card asist-header mb-3 shadow-sm">
    <div class="card-body asist-header-body">
      <div class="asist-header-main">
        <div class="asist-title">{{ headerTitle }}</div>
        <div class="asist-subtitle text-light">
          {{ headerSubtitle || 'Seleccione un periodo para revisar la asistencia.' }}
        </div>
      </div>

      <div
        class="ms-auto d-flex flex-column flex-sm-row gap-2 align-items-sm-center asist-header-meta"
      >
        <span class="badge asist-period-badge">
          {{ periodBadge || 'Semana actual' }}
        </span>

        <button
          type="button"
          class="btn btn-sm btn-outline-light asist-refresh-btn"
          (click)="actualizar()"
        >
          Actualizar
        </button>
      </div>
    </div>
  </div>

  <!-- ===== Toolbar de filtros (solo periodo) ===== -->
  <div class="card mb-3 shadow-sm">
    <div class="card-body d-flex flex-wrap align-items-center gap-3">
      <div class="d-flex flex-wrap gap-2">
        <div class="btn-group btn-group-sm" role="group" aria-label="Periodo">
          <button
            type="button"
            class="btn btn-filter"
            [class.active]="filtros.value.kind === 'week'"
            (click)="filtros.patchValue({ kind: 'week' }, { emitEvent: true })"
          >
            Semana
          </button>
          <button
            type="button"
            class="btn btn-filter"
            [class.active]="filtros.value.kind === 'month'"
            (click)="filtros.patchValue({ kind: 'month' }, { emitEvent: true })"
          >
            Mes
          </button>
          <button
            type="button"
            class="btn btn-filter"
            [class.active]="filtros.value.kind === 'year'"
            (click)="filtros.patchValue({ kind: 'year' }, { emitEvent: true })"
          >
            Año
          </button>
        </div>

        <div class="btn-group btn-group-sm" role="group" aria-label="Rango">
          <button
            type="button"
            class="btn btn-filter"
            [class.active]="filtros.value.range === 'this'"
            (click)="filtros.patchValue({ range: 'this' }, { emitEvent: true })"
          >
            Este
          </button>
          <button
            type="button"
            class="btn btn-filter"
            [class.active]="filtros.value.range === 'last'"
            (click)="filtros.patchValue({ range: 'last' }, { emitEvent: true })"
          >
            Pasado
          </button>
        </div>
      </div>

      <div class="ms-sm-auto small text-muted">
        Vista generada desde marcas de asistencia del sistema.
      </div>
    </div>
  </div>

  <!-- ===== Cards de resumen ===== -->
  <div class="row g-3 mb-3" *ngIf="cards as c">
    <div class="col-6 col-md-3">
      <div class="card card-kpi shadow-sm">
        <div class="card-body">
          <div class="kpi-label">Asistencias hoy</div>
          <div class="kpi-value">
            {{ c.asistenciasHoy }} / {{ c.totalProgramadosHoy }}
          </div>
          <div class="kpi-sub">
            Programados con horario activo hoy
          </div>
        </div>
      </div>
    </div>

    <div class="col-6 col-md-3">
      <div class="card card-kpi shadow-sm">
        <div class="card-body">
          <div class="kpi-label">Tardanzas hoy</div>
          <div class="kpi-value">{{ c.tardanzasHoy }}</div>
          <div class="kpi-sub">Entrada después de la tolerancia</div>
        </div>
      </div>
    </div>

    <div class="col-6 col-md-3">
      <div class="card card-kpi shadow-sm">
        <div class="card-body">
          <div class="kpi-label">Ausentes hoy</div>
          <div class="kpi-value">{{ c.ausentesHoy }}</div>
          <div class="kpi-sub">Sin entrada en la ventana del horario</div>
        </div>
      </div>
    </div>

    <div class="col-6 col-md-3">
      <div class="card card-kpi shadow-sm">
        <div class="card-body">
          <div class="kpi-label">Incompletos ayer</div>
          <div class="kpi-value">{{ c.incompletosAyer }}</div>
          <div class="kpi-sub">Entrada sin salida en el día anterior</div>
        </div>
      </div>
    </div>
  </div>

  <!-- ===== Zona gráfica + tabla ===== -->
  <div class="row g-3">
    <!-- Barras apiladas -->
    <div class="col-lg-6">
      <div class="card asist-card shadow-sm h-100">
        <div
          class="card-header border-0 bg-transparent d-flex justify-content-between align-items-center pb-0"
        >
          <h6 class="mb-0 asist-card-title">
            Asistencia por día (A tiempo / Tarde / Ausente / Incompleto)
          </h6>
        </div>
        <div class="card-body">
          <ng-container *ngIf="!firstLoad || !loading; else skeletonChart">
            <apx-chart
              #chartBar
              [series]="optBar.series"
              [chart]="optBar.chart"
              [xaxis]="optBar.xaxis"
              [plotOptions]="optBar.plotOptions"
              [dataLabels]="optBar.dataLabels"
              [legend]="optBar.legend"
              [tooltip]="optBar.tooltip"
              [title]="optBar.title"
              [subtitle]="optBar.subtitle"
            >
            </apx-chart>
          </ng-container>

          <ng-template #skeletonChart>
            <div class="chart-skeleton">
              <div class="sk-bar sk-bar-1"></div>
              <div class="sk-bar sk-bar-2"></div>
              <div class="sk-bar sk-bar-3"></div>
            </div>
          </ng-template>
        </div>
      </div>
    </div>

    <!-- Tabla de estado actual -->
    <div class="col-lg-6">
      <div class="card asist-card shadow-sm h-100">
        <div
          class="card-header border-0 bg-transparent d-flex justify-content-between align-items-center pb-0"
        >
          <h6 class="mb-0 asist-card-title">Estado actual de la asistencia</h6>
        </div>
        <div class="card-body table-responsive">
          <ng-container *ngIf="estadoRows.length > 0; else noData">
            <table class="table table-sm align-middle mb-0 table-asist">
              <thead>
                <tr>
                  <th>Usuario</th>
                  <th>Horario de hoy</th>
                  <th>Primera marca</th>
                  <th>Estado</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let r of estadoRows">
                  <td>{{ r.nombre }}</td>
                  <td>
                    <div class="small text-muted">{{ r.horario }}</div>
                    <div class="small" *ngIf="r.horaInicio">
                      Inicio: {{ r.horaInicio }}
                    </div>
                  </td>
                  <td>
                    <span *ngIf="r.primeraMarca; else sinMarca">
                      {{ r.primeraMarca }}
                    </span>
                    <ng-template #sinMarca>—</ng-template>
                  </td>
                  <td>
                    <span class="badge" [ngClass]="r.estadoBadgeClass">
                      {{ r.estadoLabel }}
                    </span>
                  </td>
                </tr>
              </tbody>
            </table>
          </ng-container>

          <ng-template #noData>
            <div class="text-muted small">
              No hay datos de asistencia para el periodo seleccionado.
            </div>
          </ng-template>
        </div>
      </div>
    </div>
  </div>

  <!-- Indicador de carga sencillo -->
  <div *ngIf="loading" class="asist-loading-hint">
    Actualizando datos de asistencia…
  </div>
</div>
