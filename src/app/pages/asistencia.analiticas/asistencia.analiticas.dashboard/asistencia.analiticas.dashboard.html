<div class="asist-shell">
  <!-- ===== Encabezado ===== -->
  <div class="card asist-header mb-3 shadow-sm">
    <div class="card-body asist-header-body">
      <div class="asist-header-main">
        <div class="asist-title">{{ headerTitle }}</div>
        <div class="asist-subtitle text-light">
          {{ headerSubtitle || 'Seleccione un periodo para revisar la asistencia.' }}
        </div>
      </div>

      <div class="ms-auto d-flex flex-column flex-sm-row gap-2 align-items-sm-center asist-header-meta">
        <span class="badge asist-period-badge">
          {{ periodBadge || 'Semana actual' }}
        </span>

        <button type="button" class="btn btn-sm btn-outline-light asist-refresh-btn" (click)="actualizar()">
          Actualizar
        </button>
      </div>
    </div>
  </div>

  <!-- ===== Toolbar filtros ===== -->
  <div class="card mb-3 shadow-sm">
    <div class="card-body d-flex flex-wrap align-items-center gap-3">
      <div class="d-flex flex-wrap gap-2">
        <div class="btn-group btn-group-sm" role="group" aria-label="Periodo">
          <button type="button" class="btn btn-filter"
                  [class.active]="filtros.value.kind === 'week'"
                  (click)="filtros.patchValue({ kind: 'week' }, { emitEvent: true })">
            Semana
          </button>
          <button type="button" class="btn btn-filter"
                  [class.active]="filtros.value.kind === 'month'"
                  (click)="filtros.patchValue({ kind: 'month' }, { emitEvent: true })">
            Mes
          </button>
          <button type="button" class="btn btn-filter"
                  [class.active]="filtros.value.kind === 'year'"
                  (click)="filtros.patchValue({ kind: 'year' }, { emitEvent: true })">
            Año
          </button>
        </div>

        <div class="btn-group btn-group-sm" role="group" aria-label="Rango">
          <button type="button" class="btn btn-filter"
                  [class.active]="filtros.value.range === 'this'"
                  (click)="filtros.patchValue({ range: 'this' }, { emitEvent: true })">
            Este
          </button>
          <button type="button" class="btn btn-filter"
                  [class.active]="filtros.value.range === 'last'"
                  (click)="filtros.patchValue({ range: 'last' }, { emitEvent: true })">
            Pasado
          </button>
        </div>
      </div>

      <div class="ms-sm-auto small text-muted">
        Vista generada desde marcas de asistencia del sistema.
      </div>
    </div>
  </div>

  <!-- ===== Cards ===== -->
  @if (cards; as c) {
    <div class="row g-3 mb-3">
      <div class="col-6 col-md-3">
        <div class="card card-kpi shadow-sm">
          <div class="card-body">
            <div class="kpi-label">Asistencias hoy</div>
            <div class="kpi-value">{{ c.asistenciasHoy }} / {{ c.totalProgramadosHoy }}</div>
            <div class="kpi-sub">Programados con horario activo hoy</div>
          </div>
        </div>
      </div>

      <div class="col-6 col-md-3">
        <div class="card card-kpi shadow-sm">
          <div class="card-body">
            <div class="kpi-label">Tardanzas hoy</div>
            <div class="kpi-value">{{ c.tardanzasHoy }}</div>
            <div class="kpi-sub">Entrada después de la tolerancia</div>
          </div>
        </div>
      </div>

      <div class="col-6 col-md-3">
        <div class="card card-kpi shadow-sm">
          <div class="card-body">
            <div class="kpi-label">Ausentes hoy</div>
            <div class="kpi-value">{{ c.ausentesHoy }}</div>
            <div class="kpi-sub">Sin entrada en la ventana del horario</div>
          </div>
        </div>
      </div>

      <div class="col-6 col-md-3">
        <div class="card card-kpi shadow-sm">
          <div class="card-body">
            <div class="kpi-label">Incompletos ayer</div>
            <div class="kpi-value">{{ c.incompletosAyer }}</div>
            <div class="kpi-sub">Entrada sin salida en el día anterior</div>
          </div>
        </div>
      </div>
    </div>
  }

  <!-- ===== Gráfico + Tabla ===== -->
  <div class="row g-3">
    <!-- Gráfico -->
    <div class="col-lg-6">
      <div class="card asist-card shadow-sm h-100">
        <div class="card-header border-0 bg-transparent d-flex justify-content-between align-items-center pb-0">
          <h6 class="mb-0 asist-card-title">Asistencia</h6>
        </div>

        <div class="card-body">
          @if (!firstLoad || !loadingDashboard) {
            <apx-chart
              #chartBar
              [series]="optBar.series"
              [chart]="optBar.chart"
              [xaxis]="optBar.xaxis"
              [plotOptions]="optBar.plotOptions"
              [dataLabels]="optBar.dataLabels"
              [legend]="optBar.legend"
              [tooltip]="optBar.tooltip"
              [title]="optBar.title"
              [subtitle]="optBar.subtitle">
            </apx-chart>
          } @else {
            <div class="chart-skeleton">
              <div class="sk-bar sk-bar-1"></div>
              <div class="sk-bar sk-bar-2"></div>
              <div class="sk-bar sk-bar-3"></div>
            </div>
          }
        </div>
      </div>
    </div>

    <!-- Tabla -->
    <div class="col-lg-6">
      <div class="card asist-card shadow-sm h-100">
        <div class="card-header border-0 bg-transparent d-flex justify-content-between align-items-center pb-0">
          <div>
            <h6 class="mb-0 asist-card-title">Asistencias del periodo</h6>

            <div class="btn-group btn-group-sm mt-2" role="group" aria-label="Segmento tabla">
              <button type="button" class="btn btn-filter"
                      [class.active]="tablaSegmento === 'anteriores'"
                      (click)="setSegment('anteriores')">
                Anteriores ({{ countAnteriores }})
              </button>

              <button type="button" class="btn btn-filter"
                      [class.active]="tablaSegmento === 'hoy'"
                      (click)="setSegment('hoy')">
                Hoy ({{ countHoy }})
              </button>

              <button type="button" class="btn btn-filter"
                      [class.active]="tablaSegmento === 'proximos'"
                      (click)="setSegment('proximos')">
                Próximos ({{ countProximos }})
              </button>
            </div>
          </div>

          <div class="ms-auto d-flex align-items-center gap-2">
            <button type="button"
                  class="btn btn-sm btn-outline-secondary"
                  (click)="descargarTodoPeriodo()"
                  [disabled]="downloading || loadingDashboard || !dashboard">
            Descargar (todo el periodo)
          </button>
            <div class="small text-muted">Filas/página:</div>
            
            <div class="btn-group btn-group-sm" role="group" aria-label="Page size">
              <button type="button" class="btn btn-outline-secondary"
                      [class.active]="pageSize === 10"
                      (click)="setPageSize(10)">10</button>
              <button type="button" class="btn btn-outline-secondary"
                      [class.active]="pageSize === 25"
                      (click)="setPageSize(25)">25</button>
              <button type="button" class="btn btn-outline-secondary"
                      [class.active]="pageSize === 50"
                      (click)="setPageSize(50)">50</button>
            </div>
          </div>
        </div>

        <div class="card-body table-responsive">
          @if (estadoRows.length > 0) {
            <table class="table table-sm align-middle mb-0 table-asist">
              <thead>
                <tr>
                  <th>Fecha</th>
                  <th>Usuario</th>
                  <th>Horario</th>
                  <th>Primera marca</th>
                  <th>Estado</th>
                </tr>
              </thead>

              <tbody>
                @for (r of estadoRows; track r.usId + '-' + r.fechaYmd) {
                  <tr>
                    <td>{{ r.fechaLabel }}</td>
                    <td>{{ r.nombre }}</td>
                    <td>
                      <div class="small text-muted">{{ r.horario }}</div>
                      @if (r.horaInicio) {
                        <div class="small">Inicio: {{ r.horaInicio }}</div>
                      }
                    </td>
                    <td>
                      @if (r.primeraMarca) {
                        <span>{{ r.primeraMarca }}</span>
                      } @else {
                        <span>—</span>
                      }
                    </td>
                    <td>
                      <span class="badge" [ngClass]="r.estadoBadgeClass">{{ r.estadoLabel }}</span>
                    </td>
                  </tr>
                }
              </tbody>
            </table>

            <div class="d-flex justify-content-between align-items-center mt-2">
              <div class="small text-muted">
                Mostrando {{ pageFrom }}–{{ pageTo }} de {{ estadoTotal }}
              </div>

              <div class="btn-group btn-group-sm" role="group" aria-label="Paginación">
                <button type="button" class="btn btn-outline-secondary"
                        (click)="prevPage()" [disabled]="page <= 1 || loadingPeriodo">
                  «
                </button>

                <button type="button" class="btn btn-outline-secondary" disabled>
                  Pág. {{ page }} / {{ totalPages }}
                </button>

                <button type="button" class="btn btn-outline-secondary"
                        (click)="nextPage()" [disabled]="page >= totalPages || loadingPeriodo">
                  »
                </button>
              </div>
            </div>
          } @else {
            <div class="text-muted small">
              No hay datos de asistencia para el periodo seleccionado.
            </div>
          }
        </div>
      </div>
    </div>
  </div>

  @if (loadingDashboard || loadingPeriodo) {
    <div class="asist-loading-hint">Actualizando datos de asistencia…</div>
  }
</div>
